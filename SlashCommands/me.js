const { EmbedBuilder, ActionRowBuilder, ButtonBuilder, ApplicationCommandOptionType } = require("discord.js");
const Database = require("../Database/index");
const ayarlar = require(`../ayarlar.json`)
const mesaj = new Database("Database", "Mesaj");
const ses = new Database("Database", "Ses");
const moment = require("moment");
require("moment-duration-format");
module.exports = async (interaction) => {
    let client = interaction.client;
    if (!interaction.isCommand()) return;
    if (interaction.commandName === 'me') {
    
        const num = interaction.options.getUser("kullanÄ±cÄ±")

        const row = new ActionRowBuilder()
        .addComponents(
            new ButtonBuilder()
                .setCustomId('sohbet')
                .setLabel('Chat Stat')
                .setStyle('Success')
                .setEmoji("ğŸ’¬"),
        
                new ButtonBuilder()
                .setCustomId('ses')
                .setLabel('Ses Stat')
                .setStyle('Danger')
                .setEmoji("ğŸ”‰")
        )
    let member;
    if(!num) member = interaction.guild.members.cache.get(interaction.member.id)
    else member = interaction.guild.members.cache.get(num.id)

    let member2;
    if(!num) member2 = client.users.cache.get(interaction.member.id)
    else member2 = client.users.cache.get(num.id)

    if(member2.bot) return interaction.reply({content: `${ayarlar.no} BotlarÄ±n istatistiÄŸi tutulmamaktadÄ±r.`, ephemeral: true})

    let voiceData = ses.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`) || {voice: 0, channels: {}};
    let messageData = mesaj.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`) || {messages: 0, channels: {}};

    let voiceList;
     if(ses.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`)) voiceList = Object.keys(voiceData.channels).map(vd => {
        return {
            Id: vd,
            Total: voiceData.channels[vd]
        };
    }).sort((a, b) => b.Total - a.Total);
    else voiceList = "**Veri BulunamadÄ±!**"

    let messageList;
    if(mesaj.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`)) messageList = Object.keys(messageData.channels).map(md => {
        return {
            Id: md,
            Total: messageData.channels[md]
        };
    }).sort((a, b) => b.Total - a.Total);
    else messageList = "**Veri BulunamadÄ±!**"

   if(ses.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`)) voiceList = voiceList.length > 10 ? voiceList.splice(0, 10) : voiceList;
   if(ses.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`)) voiceList = voiceList.map((vd, index)=> `\`${index + 1}.\` ${client.channels.cache.has(vd.Id) ? client.channels.cache.get(vd.Id).toString() : "#deleted-channel"}: \`${moment.duration(vd.Total).format("H [hours,] m [minutes] s [seconds]")}\``).join("\n");
   if(mesaj.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`)) messageList = messageList.length > 10 ? messageList.splice(0, 10) : messageList;
   if(mesaj.bul(`stats.${interaction.guild.id}.${interaction.guild.id}.${member.id}`)) messageList = messageList.map((md, index)=> `\`${index + 1}.\` ${client.channels.cache.has(md.Id) ? client.channels.cache.get(md.Id).toString() : "#deleted-channel"}: \`${md.Total} message\``).join("\n");

    let rolemap = member.roles.cache
    .filter((roles) => roles.id !== interaction.guild.id)
    .sort((a, b) => b.position - a.position)
    .map(r => r)
    .join(",");
    if (rolemap.length > 1024) rolemap = "Rol sayÄ±sÄ± gÃ¶steremeyeceÄŸim kadar Ã§ok!";
    if (!rolemap) rolemap = "Rol bulunamadÄ±";

const embed = new EmbedBuilder()
.setTitle(`**KullanÄ±cÄ± Bilgileri**`)
.setColor("000000")
.setThumbnail(member2.avatarURL({dynamic: true, size: 2048 }))
.setDescription(
  `â€¢ KullanÄ±cÄ±: (${member.toString()} - \`${member.id}\`) (${member.roles.highest})
   â€¢ Hesap Kurulum Tarihi: \`${moment(member.user.createdAt).format('D MMMM YYYY')}\`
   â€¢ Sunucuya KatÄ±lma Tarihi: \`${moment(member.joinedAt).format('D MMMM YYYY')}\`
   â€¢ Rolleri: ${rolemap}`)
.setFooter({text:client.user.username ,iconURL: member2.avatarURL({})})
.setTimestamp();

await interaction.reply({embeds: [embed], components: [row]}).then((msg) => {

const embed2 = new EmbedBuilder()
.setTitle(`ğŸ”‰ **Ses Ä°statistiÄŸi**`)
.setColor("000000")
.setThumbnail(member2.avatarURL({dynamic: true, size: 2048 }))
.setDescription(
  `**(${member2.username}** - \`${member.id})\`
   
  ${voiceList}
  `)
.addFields({name: `Not:`, value: `\`Ses Ä°statistikleri sesten Ã§Ä±ktÄ±ktan sonra gÃ¼ncellenir!\``})
.setFooter({text:client.user.username ,iconURL: member2.avatarURL({})})
.setTimestamp();

const embed3 = new EmbedBuilder()
.setTitle(`ğŸ’¬ **Chat Ä°statistiÄŸi**`)
.setColor("000000")
.setThumbnail(member2.avatarURL({dynamic: true, size: 2048 }))
.setDescription(
  `**(${member2.username}** - \`${member.id})\`
   
  ${messageList}
  `)
.addFields({name: `Not:`, value: `\`Chat Ä°statikleri anÄ±nda gÃ¼ncellenir!\``})
.setFooter({text:client.user.username ,iconURL: member2.avatarURL({})})
.setTimestamp();

const filter = i => i.user.id === interaction.member.id;
const collector = interaction.channel.createMessageComponentCollector({ filter, time: 15000 });
collector.on('collect', async i => {
if(i.customId === "ses") {
await msg.edit({embeds: [embed2], components: []})
}
if(i.customId === "sohbet") {
 await msg.edit({embeds: [embed3], components: []})
  }
})
})
    }

}
module.exports.conf = {
    event:"interactionCreate",
    name: "me",
    description:"HakkÄ±nÄ±zda istatistik gÃ¶sterir",
        name2: "kullanÄ±cÄ±",
        description2:"Bir kullanÄ±cÄ± belirtin",
        required: false,
        type: ApplicationCommandOptionType.User
};